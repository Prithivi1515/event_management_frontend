<div class="container-fluid py-4">
  <!-- Page Header -->
  <header class="row mb-4">
    <div class="col-12">
      <div class="page-header">
        <h1 class="page-title">
          <i class="bi bi-calendar2-week me-3" aria-hidden="true"></i>
          Discover Events
        </h1>
        <p class="page-subtitle">Find amazing events happening around you</p>
        
        <div class="login-status mt-2" *ngIf="!isLoggedIn">
          <small class="text-warning">
            <i class="bi bi-info-circle me-1" aria-hidden="true"></i>
            <a [routerLink]="['/login']" class="text-warning text-decoration-underline">Login</a> to book tickets
          </small>
        </div>
      </div>
    </div>
  </header>

  <!-- Filters Section -->
  <section class="row mb-4" aria-label="Event filters">
    <div class="col-12">
      <div class="filters-card card shadow-sm border-0">
        <div class="card-body">
          <form role="search" aria-label="Filter events" (ngSubmit)="applyFilters()" #filterForm="ngForm">
            <div class="row g-4">
              <!-- Search Input -->
              <div class="col-xl-4 col-lg-5 col-md-6">
                <div class="filter-group">
                  <label for="search-input" class="filter-label">
                    <i class="bi bi-search me-2" aria-hidden="true"></i>
                    Search Events
                  </label>
                  <div class="input-group">
                    <span class="input-group-text">
                      <i class="bi bi-search" aria-hidden="true"></i>
                    </span>
                    <input 
                      id="search-input"
                      type="text" 
                      class="form-control" 
                      placeholder="Search events, categories, locations..."
                      [(ngModel)]="searchTerm"
                      (input)="onSearchInput($any($event.target).value)"
                      (keyup.enter)="applyFilters()"
                      name="search"
                      aria-describedby="search-help">
                    <button 
                      type="button" 
                      class="btn btn-outline-secondary"
                      *ngIf="searchTerm"
                      (click)="searchTerm = ''; onSearchInput('')"
                      title="Clear search"
                      aria-label="Clear search">
                      <i class="bi bi-x"></i>
                    </button>
                  </div>
                  <small id="search-help" class="filter-help-text">
                    Search by event name, description, category, or location
                  </small>
                </div>
              </div>

              <!-- Category Filter -->
              <div class="col-xl-2 col-lg-2 col-md-3 col-sm-6">
                <div class="filter-group">
                  <label for="category-select" class="filter-label">
                    <i class="bi bi-tag me-2" aria-hidden="true"></i>
                    Category
                    <span class="badge bg-primary ms-auto" *ngIf="selectedCategory">1</span>
                  </label>
                  <select 
                    id="category-select"
                    class="form-select" 
                    [(ngModel)]="selectedCategory" 
                    (change)="onCategoryChange()"
                    name="category">
                    <option value="">All Categories</option>
                    <option *ngFor="let category of categories" [value]="category">
                      {{ category | titlecase }}
                    </option>
                  </select>
                </div>
              </div>

              <!-- Location Filter -->
              <div class="col-xl-2 col-lg-2 col-md-3 col-sm-6">
                <div class="filter-group">
                  <label for="location-select" class="filter-label">
                    <i class="bi bi-geo-alt me-2" aria-hidden="true"></i>
                    Location
                    <span class="badge bg-primary ms-auto" *ngIf="selectedLocation">1</span>
                  </label>
                  <select 
                    id="location-select"
                    class="form-select" 
                    [(ngModel)]="selectedLocation" 
                    (change)="onLocationChange()"
                    name="location">
                    <option value="">All Locations</option>
                    <option *ngFor="let location of locations" [value]="location">
                      {{ location }}
                    </option>
                  </select>
                </div>
              </div>

              <!-- Date Filter -->
              <div class="col-xl-2 col-lg-2 col-md-3 col-sm-6">
                <div class="filter-group">
                  <label for="date-select" class="filter-label">
                    <i class="bi bi-calendar me-2" aria-hidden="true"></i>
                    Date Range
                    <span class="badge bg-primary ms-auto" *ngIf="selectedDateRange">1</span>
                  </label>
                  <select 
                    id="date-select"
                    class="form-select" 
                    [(ngModel)]="selectedDateRange" 
                    (change)="onDateRangeChange()"
                    name="dateRange">
                    <option value="">All Dates</option>
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                    <option value="upcoming">Upcoming</option>
                  </select>
                </div>
              </div>

              <!-- Filter Actions -->
              <div class="col-xl-2 col-lg-1 col-md-3 col-sm-6">
                <div class="filter-actions-wrapper">
                  <div class="filter-actions">
                    <label class="filter-label d-block">
                      <i class="bi bi-funnel me-2" aria-hidden="true"></i>
                      Actions
                    </label>
                    <div class="filter-buttons-container">
                      <!-- Apply Filters Button -->
                      <button 
                        type="submit"
                        class="btn-filter-apply" 
                        [class.loading]="isLoading"
                        [disabled]="isLoading"
                        title="Apply current filters"
                        aria-label="Apply filters">
                        <span *ngIf="!isLoading">
                          <i class="bi bi-funnel" aria-hidden="true"></i>
                          <span class="d-none d-lg-inline">Apply</span>
                        </span>
                      </button>
                      
                      <!-- Clear All Filters Button -->
                      <button 
                        type="button"
                        class="btn-filter-clear" 
                        (click)="clearFilters()" 
                        [disabled]="isLoading || (!searchTerm && !selectedCategory && !selectedLocation && !selectedDateRange)"
                        title="Clear all filters"
                        aria-label="Clear all filters">
                        <i class="bi bi-x-circle" aria-hidden="true"></i>
                      </button>
                    </div>
                    
                    <!-- Filter Status Indicator -->
                    <div class="filter-status-indicator" *ngIf="hasActiveFilters()">
                      <div class="active-filter-count">
                        <i class="bi bi-check-circle" aria-hidden="true"></i>
                        <span>{{ getActiveFiltersCount() }} active</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </section>

  <!-- Enhanced Results Summary -->
  <section class="row mb-3" *ngIf="!isLoading" aria-label="Search results summary">
    <div class="col-12">
      <div class="results-summary d-flex justify-content-between align-items-center">
        <div>
          <p class="mb-0">
            <strong>{{ filteredEvents.length }}</strong> 
            {{ filteredEvents.length === 1 ? 'event' : 'events' }} found
            <span *ngIf="allEvents.length > 0"> out of {{ allEvents.length }} total</span>
            <span *ngIf="searchTerm"> for "{{ searchTerm }}"</span>
            <span *ngIf="selectedCategory"> in {{ selectedCategory | titlecase }}</span>
            <span *ngIf="selectedLocation"> in {{ selectedLocation }}</span>
          </p>
          <small class="text-muted">
            <span *ngIf="currentPage > 1"> â€¢ Page {{ currentPage }} of {{ totalPages }}</span>
          </small>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-outline-primary" (click)="refreshEvents()" [disabled]="isLoading" title="Refresh events">
            <i class="bi bi-arrow-clockwise"></i>
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- Loading State -->
  <div class="row" *ngIf="isLoading" role="status" aria-live="polite">
    <div class="col-12">
      <div class="loading-container text-center py-5">
        <div class="spinner-border text-primary mb-3" role="status">
          <span class="visually-hidden">Loading events...</span>
        </div>
        <p class="text-muted">Loading events...</p>
      </div>
    </div>
  </div>

  <!-- Error State -->
  <div class="row" *ngIf="errorMessage && !isLoading" role="alert">
    <div class="col-12">
      <div class="alert alert-warning text-center">
        <i class="bi bi-exclamation-triangle-fill me-2" aria-hidden="true"></i>
        {{ errorMessage }}
        <button class="btn btn-outline-primary btn-sm ms-3" (click)="refreshEvents()">
          Try Again
        </button>
      </div>
    </div>
  </div>

  <!-- Events Grid -->
  <main class="row g-4" *ngIf="!isLoading && !errorMessage">
    <article 
      class="col-lg-4 col-md-6" 
      *ngFor="let event of getPaginatedEvents();">
      <div class="event-card card h-100 border-0 shadow-sm">
        <!-- Event Image -->
        <div class="event-image-container">
          <img 
            [src]="event.imageUrl" 
            [alt]="event.name + ' event image'" 
            class="card-img-top event-image"
            (error)="handleImageError(event)"
            loading="lazy">
          <div class="event-category-badge">
            {{ event.category | titlecase }}
          </div>
          <!-- Add Price Badge to Image -->
          <div class="event-price-badge" [ngClass]="getPriceClass(event.ticketPrice)">
            {{ formatPrice(event.ticketPrice) }}
          </div>
        </div>

        <div class="card-body d-flex flex-column">
          <!-- Event Title -->
          <h3 class="card-title event-title">{{ event.name }}</h3>
          
          <!-- Event Info -->
          <div class="event-info mb-3">
            <div class="info-item">
              <i class="bi bi-calendar3 me-2" aria-hidden="true"></i>
              <span>{{ formatDate(event.date) }}</span>
            </div>
            <div class="info-item">
              <i class="bi bi-clock me-2" aria-hidden="true"></i>
              <span>{{ event.time }}</span>
              <small class="text-muted ms-2">({{ getEventTimeStatus(event.date) }})</small>
            </div>
            <div class="info-item">
              <i class="bi bi-geo-alt me-2" aria-hidden="true"></i>
              <span>{{ event.venue }}</span>
            </div>
            <div class="info-item">
              <i class="bi bi-people me-2" aria-hidden="true"></i>
              <span>{{ event.ticketCount }} total seats</span>
            </div>
            <!-- Add Price Info Item -->
            <div class="info-item">
              <i class="bi bi-currency-rupee me-2" aria-hidden="true"></i>
              <span class="price-display" [ngClass]="getPriceClass(event.ticketPrice)">
                {{ formatPrice(event.ticketPrice) }}
              </span>
            </div>
          </div>

          <!-- Event Description -->
          <p class="card-text event-description">
            {{ event.description }}
          </p>

          <!-- Price and Booking Section -->
          <div class="price-booking-section mb-3 p-3 bg-light rounded">
            <div class="d-flex justify-content-between align-items-center">
              <div class="price-info">
                <small class="text-muted">Ticket Price</small>
                <div class="price-amount h5 mb-0" [ngClass]="getPriceClass(event.ticketPrice)">
                  {{ formatPrice(event.ticketPrice) }}
                </div>
                <small class="text-muted" *ngIf="event.ticketPrice > 0">per person</small>
              </div>
              <div class="booking-indicator">
                <i class="bi bi-ticket-perforated fs-3 text-primary" aria-hidden="true"></i>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="mt-auto">
            <div class="d-grid gap-2">
              
              <!-- Book Now Button -->
              <ng-container *ngIf="isLoggedIn; else loginRequired">
                <button 
                  class="btn btn-outline-primary event-btn" 
                  [disabled]="event.availableSeats === 0"
                  (click)="handleBooking(event)"
                  [attr.aria-label]="event.availableSeats === 0 ? 'Sold out' : 'Book tickets for ' + event.name + ' at ' + formatPrice(event.ticketPrice)">
                  <i class="bi bi-ticket-perforated me-2" aria-hidden="true"></i>
                  {{ event.availableSeats === 0 ? 'Sold Out' : 'Book at ' + formatPrice(event.ticketPrice) }}
                </button>
              </ng-container>
              
              <!-- Login Required Template -->
              <ng-template #loginRequired>
                <button 
                  class="btn btn-outline-warning event-btn" 
                  (click)="goToLogin()"
                  aria-label="Login required to book tickets">
                  <i class="bi bi-lock me-2" aria-hidden="true"></i>
                  Login to Book
                </button>
              </ng-template>
            </div>
          </div>
        </div>
      </div>
    </article>
  </main>

  <!-- Empty State -->
  <div class="row" *ngIf="!isLoading && !errorMessage && filteredEvents.length === 0">
    <div class="col-12">
      <div class="empty-state text-center py-5">
        <i class="bi bi-calendar-x display-1 text-muted mb-3" aria-hidden="true"></i>
        <h3 class="mb-3">No upcoming events found</h3>
        <p class="text-muted mb-4">
          We only show upcoming events. Try adjusting your filters or search terms to find events.
        </p>
        <button class="btn btn-primary" (click)="clearFilters()">
          <i class="bi bi-arrow-clockwise me-2" aria-hidden="true"></i>Clear Filters
        </button>
      </div>
    </div>
  </div>

  <!-- Pagination -->
  <nav 
    class="row mt-5" 
    *ngIf="!isLoading && filteredEvents.length > itemsPerPage"
    aria-label="Events pagination">
    <div class="col-12">
      <ul class="pagination justify-content-center">
        <li class="page-item" [class.disabled]="currentPage === 1">
          <button 
            class="page-link" 
            (click)="goToPage(currentPage - 1)" 
            [disabled]="currentPage === 1"
            aria-label="Previous page">
            <i class="bi bi-chevron-left" aria-hidden="true"></i>
          </button>
        </li>
        
        <li 
          class="page-item" 
          *ngFor="let page of getPaginationArray()" 
          [class.active]="currentPage === page">
          <button 
            class="page-link" 
            (click)="goToPage(page)"
            [attr.aria-label]="'Go to page ' + page"
            [attr.aria-current]="currentPage === page ? 'page' : null">
            {{ page }}
          </button>
        </li>
        
        <li class="page-item" [class.disabled]="currentPage === totalPages">
          <button 
            class="page-link" 
            (click)="goToPage(currentPage + 1)" 
            [disabled]="currentPage === totalPages"
            aria-label="Next page">
            <i class="bi bi-chevron-right" aria-hidden="true"></i>
          </button>
        </li>
      </ul>
    </div>
  </nav>
</div>
